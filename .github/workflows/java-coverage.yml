name: Java coverage

on:
  workflow_call:
    inputs:
      pull-request-number:
        description: "Pull request number to comment on"
        required: false
        default: 0
        type: number
      ci-pipelines-ref:
        description: "Ref (branch/tag/SHA) of ci-pipelines to use for the Dagger module"
        required: false
        default: "main"
        type: string

jobs:
  coverage-comment:
    runs-on: ubuntu-24.04-arm

    permissions:
      contents: read
      pull-requests: write  # needed to comment on PR

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Dagger CLI
        uses: dagger/dagger-for-github@v8.2.0
        with:
          version: "0.19.8"

      - name: Generate coverage summary markdown
        run: |
          dagger call \
            --mod github.com/dario-mr/ci-pipelines@${{ inputs.ci-pipelines-ref }} \
            coverage-markdown \
            --source . > coverage.md

      - name: Create or update PR coverage comment
        if: inputs.pull-request-number != 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('coverage.md', 'utf8');
            const marker = "<!-- ci-pipelines:coverage-comment -->";

            const { owner, repo } = context.repo;
            const issue_number = Number('${{ inputs.pull-request-number }}');
            if (!issue_number) {
              core.setFailed("Missing inputs.pull-request-number.");
              return;
            }

            // List all comments on the PR
            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number }
            );

            // Find an existing comment with our marker
            const existing = comments.find(c => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
